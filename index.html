<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check Address</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC5UvzBe-bW6t15QpawOADRt88Vaovc5eE&libraries=places"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="new-header">
        <a href="https://communityfiber.net/" target="_blank">
            <img src="icons/community-fiber-logo.png" alt="Community Fiber Logo" class="logo">
        </a>

    </div>
    <div class="service-check-container" id="service-check-container">
        <h2>Can We Serve Your Address?</h2>
        <h3>Check if your address can receive our services! We offer fast and reliable internet to areas within our coverage zone. Please enter your address to verify availability.</h3>
    
        <form id="addressForm">
            <input type="text" id="addressInput" placeholder="Start typing your address" />
        </form>
        <button type="addressbutton" onclick="checkAddress()">Check Address</button>
    </div>

    <div id="resultContainer"></div> <!-- New result container -->

    <script>
        function initAutocomplete() {
            var input = document.getElementById('addressInput');
            var autocomplete = new google.maps.places.Autocomplete(input);
        }

function checkAddress() {
    var address = document.getElementById('addressInput').value;

    if (address.trim() === "") {
        alert("Please enter a valid address.");
        return;
    }

    // Hide the service check container once the address is entered
    document.getElementById('service-check-container').style.display = 'none';

    var geocoder = new google.maps.Geocoder();
    geocoder.geocode({ address: address }, function (results, status) {
        if (status === 'OK' && results[0]) {
            var coordinates = results[0].geometry.location;
            console.log("Coordinates:", coordinates);

            // Store the address in the database
            storeAddressInDatabase(address);

            // Call the new endpoint to get the tag for the coordinates
            getTagForCoordinates(coordinates.lat(), coordinates.lng(), address);
        } else {
            document.getElementById('resultContainer').innerHTML = '<p>Error: Geocoding failed.</p>';
        }
    });
}

function storeAddressInDatabase(address) {
    const url = "http://localhost:3000/storeAddress"; // Your backend endpoint
    const data = { address: address };

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        console.log("Address stored successfully:", data);
    })
    .catch(error => {
        console.error('Error storing address:', error);
    });
}


        function getTagForCoordinates(latitude, longitude, address) {
            const url = `http://localhost:3000/getTagForCoordinates?latitude=${latitude}&longitude=${longitude}&address=${encodeURIComponent(address)}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.tag === null || data.tag === undefined) {
                        loadSorryPage(address);
                    } else {
                        loadPricingPage(address);
                    }
                })
                .catch(error => {
                    console.error('Error:', error.message);
                    alert('Something went wrong. Please try again.');
                });
        }

        function loadSorryPage(address) {
            window.location.href = `sorry.html?address=${encodeURIComponent(address)}`;
        }

        function loadPricingPage(address) {
            window.location.href = `pricing.html?address=${encodeURIComponent(address)}`;
        }

        initAutocomplete();
    </script>

    <!-- Embedded Footer -->
    <div class="footer-container">
        <footer class="fusion-footer-widget-area fusion-widget-area">
            <div class="fusion-row">
                <div class="fusion-columns fusion-columns-2 fusion-widget-area">
                    <div class="fusion-column col-lg-6 col-md-6 col-sm-6">
                        <section id="text-3" class="fusion-footer-widget-column widget widget_text">
                            <h4 class="widget-title fusion-responsive-typography-calculated" data-fontsize="15" style="--fontSize: 15; line-height: 1; --minFontSize: 15;" data-lineheight="15px">
                                Contact Information:
                            </h4>
                            <div class="textwidget">
                                <p>For sales, service, or to report a problem call: 574-533-4237 or<br>toll free: 844-New-Fiber (844-639-3423)</p>
                            </div>
                            <div style="clear:both;"></div>
                        </section>
                    </div>
                    <div class="fusion-column fusion-column-last col-lg-6 col-md-6 col-sm-6">
                        <style type="text/css" data-id="text-4">
                            @media (max-width: 800px) {#text-4 {text-align: initial !important;}}
                        </style>
                        <section id="text-4" class="fusion-widget-mobile-align-initial fusion-widget-align-right fusion-footer-widget-column widget widget_text" style="border-style: solid; text-align: right; border-color: transparent; border-width: 0px;">
                            <div class="textwidget">
                                <p><a href="https://communityfiber.net/internet-policies/"><strong>NPT / CFN Open Internet Policies</strong></a></p>
                            </div>
                            <div style="clear:both;"></div>
                        </section>
                    </div>
                    <div class="fusion-clearfix"></div>
                </div>
            </div>
        </footer>
        <footer id="footer" class="fusion-footer-copyright-area">
            <div class="fusion-row">
                <div class="fusion-copyright-content">
                    <div class="fusion-copyright-notice" style="padding-bottom: 0px;">
                        <div>
                            Copyright 2024 Community Fiber Network - an NPTech Company | 19066 Market St / PO Box 47, New Paris IN 46553
                        </div>
                    </div>
                    <div class="fusion-social-links-footer" style="display: none;"></div>
                </div>
            </div>
        </footer>
    </div>
</body>
</html>